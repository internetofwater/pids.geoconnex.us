name: geoconnex.us database build

on: 
  push:
    branches: 
      - 'dev'
    #  - 'main'
    # paths:
    #   - 'namespaces/**'

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build MySQL and Python containers for Yourls
        env:
          YOURLS_DB_USER: ${{ secrets.YOURLS_DB_USER }}
          YOURLS_DB_PASSWORD: ${{ secrets.YOURLS_DB_PASSWORD }}
        run: |
          docker compose up -d --build
          cp -R namespaces/ ./build/namespaces/
          docker build -t build_yourls_uploader ./build/

      - name: Fill Yourls table with data from namespaces
        env:
          YOURLS_DB_USER: ${{ secrets.YOURLS_DB_USER }}
          YOURLS_DB_PASSWORD: ${{ secrets.YOURLS_DB_PASSWORD }}
        run: |
          docker run --rm --network=pids_yourls_host --name build_yourls \
            --env YOURLS_DB_PASSWORD=${YOURLS_DB_PASSWORD:-arootpassword} --env YOURLS_DB_USER=${YOURLS_DB_USER:-root} \
            -v /sitemap:/sitemap build_yourls_uploader
          docker exec pids-mysql-1 sh -c "mysqldump --databases yourls -u ${YOURLS_DB_USER:-root} --password=${YOURLS_DB_PASSWORD:-arootpassword} --hex-blob --set-gtid-purged=OFF --default-character-set=utf8mb4 --single-transaction --skip-triggers --no-autocommit | gzip > /docker-entrypoint-initdb.d/yourls.sql.gz"
          mkdir backup
          cp ./mysql/yourls.sql.gz backup/yourls.sql.gz
          cp -R /sitemap sitemap
          cp -R /sitemap yourls/sitemap
          docker compose down

      - name: Build and push geoconnex-mysql
        id: docker_build_mysql
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: webbben/pids-geoconnex-mysql:latest
          context: mysql

      - name: Build and push geoconnex-yourls
        id: docker_build_yourls
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: webbben/pids-geoconnex-yourls:latest
          context: yourls

      - name: Push sitemap to geoconnex.us
        uses: DevOpenWRT-Router/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: 'sitemap'
          destination-repository-name: 'webb-ben/geoconnex.us'
          target-branch: 'dev'
          target-directory: 'sitemap'
          user-email: 'benjamin.miller.webb@gmail.com'
          user-name: 'webb-ben'

      - name: Push backup to geoconnex.us
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source_file: 'backup'
          destination_repo: 'webb-ben/geoconnex.us'
          destination_branch: 'dev'
          user_email: 'benjamin.miller.webb@gmail.com'
          user_name: 'webb-ben'
