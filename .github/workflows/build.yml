name: Yourls build for geoconnex.us

on:
  push:
    branches:
      # - 'dev'
     - 'main'
    paths:
      - 'build/namespaces/**'

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build MySQL and Python containers for Yourls
        env:
          YOURLS_DB_USER: ${{ secrets.YOURLS_DB_USER }}
          YOURLS_DB_PASSWORD: ${{ secrets.YOURLS_DB_PASSWORD }}
        run: |
          docker compose -p pidsgeoconnexus up -d --build
          docker build -t build_yourls_uploader ./build/

      - name: Fill Yourls table with data from namespaces
        env:
          YOURLS_DB_USER: ${{ secrets.YOURLS_DB_USER }}
          YOURLS_DB_PASSWORD: ${{ secrets.YOURLS_DB_PASSWORD }}
        run: |
          docker run --rm --network=pidsgeoconnexus_yourls_host --name build_yourls \
            --env YOURLS_DB_PASSWORD=${YOURLS_DB_PASSWORD:-arootpassword} --env YOURLS_DB_USER=${YOURLS_DB_USER:-root} \
            -v /sitemap:/sitemap build_yourls_uploader
          docker exec pidsgeoconnexus-mysql-1  sh -c "mysqldump --databases yourls -u ${YOURLS_DB_USER:-root} --password=${YOURLS_DB_PASSWORD:-arootpassword} --hex-blob --default-character-set=utf8mb4 --skip-triggers --set-gtid-purged=OFF | gzip > /docker-entrypoint-initdb.d/yourls.sql.gz"
          mkdir backup
          cp ./mysql/yourls.sql.gz backup/yourls.sql.gz
          cp -R /sitemap yourls/sitemap
          docker compose down

      - name: Zip sitemap
        uses: vimtor/action-zip@v1
        with:
          files: yourls/sitemap
          dest: backup/sitemap.zip

      - name: Build and push yourls-mysql
        id: docker_build_mysql
        uses: docker/build-push-action@v2
        with:
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: internetofwater/yourls-mysql:latest
          context: mysql

      - name: Build and push yourls
        id: docker_build_yourls
        uses: docker/build-push-action@v2
        with:
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: internetofwater/yourls:latest
          context: yourls

      - name: Push backup to geoconnex.us
        uses: DevOpenWRT-Router/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: backup
          destination-repository-name: internetofwater/geoconnex.us
          target-branch: master
          target-directory: PID-server/backup
          user-email: benjamin.miller.webb@gmail.com
          user-name: webb-ben
